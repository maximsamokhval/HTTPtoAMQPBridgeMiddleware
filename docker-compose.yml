services:
  # ==========================================================================
  # RabbitMQ Message Broker with EDI plugins
  # ==========================================================================
  rabbitmq:
    build: ./rabbitmq
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    networks:
      - rmq-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ==========================================================================
  # RMQ Middleware Application
  # ==========================================================================
  middleware:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rmq-middleware-app
    ports:
      - "8000:8000"
    environment:
      # ⚠️ SECURITY WARNING: Use secrets management in production (Docker secrets, Vault, etc.)
      # Never commit real credentials to version control
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/edi
      RABBITMQ_PREFETCH_COUNT: 10
      RETRY_ATTEMPTS: 60
      RETRY_BASE_DELAY: 1.0
      PUBLISH_TIMEOUT: 30.0
      CONSUME_TIMEOUT: 30.0
      LOG_LEVEL: INFO
      LOG_FORMAT: text
      LOG_FILE: /var/log/rmq-middleware/app.log
      APP_NAME: rmq-middleware
      APP_HOST: 0.0.0.0
      APP_PORT: 8000
      # Security settings (enable in production)
      API_KEY_ENABLED: "false"
      # API_KEY: "set-via-secrets-manager"
      RATE_LIMIT_ENABLED: "false"
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./logs:/var/log/rmq-middleware
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - rmq-network
    restart: unless-stopped

networks:
  rmq-network:
    driver: bridge
